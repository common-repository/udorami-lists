
(function(root,factory){if(typeof define==='function'&&define.amd){define([],factory);}else if(typeof exports==='object'){module.exports=factory();}else{root.salvattore=factory();}}(this,function(){if(!window.matchMedia){window.matchMedia=function(){"use strict";var styleMedia=(window.styleMedia||window.media);if(!styleMedia){var style=document.createElement('style'),script=document.getElementsByTagName('script')[0],info=null;style.type='text/css';style.id='matchmediajs-test';script.parentNode.insertBefore(style,script);info=('getComputedStyle'in window)&&window.getComputedStyle(style,null)||style.currentStyle;styleMedia={matchMedium:function(media){var text='@media '+media+'{ #matchmediajs-test { width: 1px; } }';if(style.styleSheet){style.styleSheet.cssText=text;}else{style.textContent=text;}
return info.width==='1px';}};}
return function(media){return{matches:styleMedia.matchMedium(media||'all'),media:media||'all'};};}();}
(function(){"use strict";if(window.matchMedia&&window.matchMedia('all').addListener){return false;}
var localMatchMedia=window.matchMedia,hasMediaQueries=localMatchMedia('only all').matches,isListening=false,timeoutID=0,queries=[],handleChange=function(evt){clearTimeout(timeoutID);timeoutID=setTimeout(function(){for(var i=0,il=queries.length;i<il;i++){var mql=queries[i].mql,listeners=queries[i].listeners||[],matches=localMatchMedia(mql.media).matches;if(matches!==mql.matches){mql.matches=matches;for(var j=0,jl=listeners.length;j<jl;j++){listeners[j].call(window,mql);}}}},30);};window.matchMedia=function(media){var mql=localMatchMedia(media),listeners=[],index=0;mql.addListener=function(listener){if(!hasMediaQueries){return;}
if(!isListening){isListening=true;window.addEventListener('resize',handleChange,true);}
if(index===0){index=queries.push({mql:mql,listeners:listeners});}
listeners.push(listener);};mql.removeListener=function(listener){for(var i=0,il=listeners.length;i<il;i++){if(listeners[i]===listener){listeners.splice(i,1);}}};return mql;};}());(function(){"use strict";var lastTime=0;var vendors=['ms','moz','webkit','o'];for(var x=0;x<vendors.length&&!window.requestAnimationFrame;++x){window.requestAnimationFrame=window[vendors[x]+'RequestAnimationFrame'];window.cancelAnimationFrame=window[vendors[x]+'CancelAnimationFrame']||window[vendors[x]+'CancelRequestAnimationFrame'];}
if(!window.requestAnimationFrame)
window.requestAnimationFrame=function(callback,element){var currTime=new Date().getTime();var timeToCall=Math.max(0,16-(currTime-lastTime));var id=window.setTimeout(function(){callback(currTime+timeToCall);},timeToCall);lastTime=currTime+timeToCall;return id;};if(!window.cancelAnimationFrame)
window.cancelAnimationFrame=function(id){clearTimeout(id);};}());if(typeof window.CustomEvent!=="function"){(function(){"use strict";function CustomEvent(event,params){params=params||{bubbles:false,cancelable:false,detail:undefined};var evt=document.createEvent('CustomEvent');evt.initCustomEvent(event,params.bubbles,params.cancelable,params.detail);return evt;}
CustomEvent.prototype=window.Event.prototype;window.CustomEvent=CustomEvent;})();}
var salvattore=(function(global,document,undefined){"use strict";var self={},grids=[],mediaRules=[],mediaQueries=[],add_to_dataset=function(element,key,value){if(element.dataset){element.dataset[key]=value;}else{element.setAttribute("data-"+key,value);}
return;};self.obtainGridSettings=function obtainGridSettings(element){var computedStyle=global.getComputedStyle(element,":before"),content=computedStyle.getPropertyValue("content").slice(1,-1),matchResult=content.match(/^\s*(\d+)(?:\s?\.(.+))?\s*$/),numberOfColumns=1,columnClasses=[];if(matchResult){numberOfColumns=matchResult[1];columnClasses=matchResult[2];columnClasses=columnClasses?columnClasses.split("."):["column"];}else{matchResult=content.match(/^\s*\.(.+)\s+(\d+)\s*$/);if(matchResult){columnClasses=matchResult[1];numberOfColumns=matchResult[2];if(numberOfColumns){numberOfColumns=numberOfColumns.split(".");}}}
return{numberOfColumns:numberOfColumns,columnClasses:columnClasses};};self.addColumns=function addColumns(grid,items){var settings=self.obtainGridSettings(grid),numberOfColumns=settings.numberOfColumns,columnClasses=settings.columnClasses,columnsItems=new Array(+numberOfColumns),columnsFragment=document.createDocumentFragment(),i=numberOfColumns,selector;while(i--!==0){selector="[data-umicolumns] > *:nth-child("+numberOfColumns+"n-"+i+")";columnsItems.push(items.querySelectorAll(selector));}
columnsItems.forEach(function append_to_grid_fragment(rows){var column=document.createElement("div"),rowsFragment=document.createDocumentFragment();column.className=columnClasses.join(" ");Array.prototype.forEach.call(rows,function append_to_column(row){rowsFragment.appendChild(row);});column.appendChild(rowsFragment);columnsFragment.appendChild(column);});grid.appendChild(columnsFragment);add_to_dataset(grid,'umicolumns',numberOfColumns);};self.removeColumns=function removeColumns(grid){var range=document.createRange();range.selectNodeContents(grid);var columns=Array.prototype.filter.call(range.extractContents().childNodes,function filter_elements(node){return node instanceof global.HTMLElement;});var numberOfColumns=columns.length,numberOfRowsInFirstColumn=columns[0].childNodes.length,sortedRows=new Array(numberOfRowsInFirstColumn*numberOfColumns);Array.prototype.forEach.call(columns,function iterate_columns(column,columnIndex){Array.prototype.forEach.call(column.children,function iterate_rows(row,rowIndex){sortedRows[rowIndex*numberOfColumns+columnIndex]=row;});});var container=document.createElement("div");add_to_dataset(container,'umicolumns',0);sortedRows.filter(function filter_non_null(child){return!!child;}).forEach(function append_row(child){container.appendChild(child);});return container;};self.recreateColumns=function recreateColumns(grid){global.requestAnimationFrame(function render_after_css_mediaQueryChange(){self.addColumns(grid,self.removeColumns(grid));var columnsChange=new CustomEvent("columnsChange");grid.dispatchEvent(columnsChange);});};self.mediaQueryChange=function mediaQueryChange(mql){if(mql.matches){Array.prototype.forEach.call(grids,self.recreateColumns);}};self.getCSSRules=function getCSSRules(stylesheet){var cssRules;try{cssRules=stylesheet.sheet.cssRules||stylesheet.sheet.rules;}catch(e){return[];}
return cssRules||[];};self.getStylesheets=function getStylesheets(){var inlineStyleBlocks=Array.prototype.slice.call(document.querySelectorAll("style"));inlineStyleBlocks.forEach(function(stylesheet,idx){if(stylesheet.type!=='text/css'&&stylesheet.type!==''){inlineStyleBlocks.splice(idx,1);}});return Array.prototype.concat.call(inlineStyleBlocks,Array.prototype.slice.call(document.querySelectorAll("link[rel='stylesheet']")));};self.mediaRuleHasColumnsSelector=function mediaRuleHasColumnsSelector(rules){var i,rule;try{i=rules.length;}
catch(e){i=0;}
while(i--){rule=rules[i];if(rule.selectorText&&rule.selectorText.match(/\[data-umicolumns\](.*)::?before$/)){return true;}}
return false;};self.scanMediaQueries=function scanMediaQueries(){var newMediaRules=[];if(!global.matchMedia){return;}
self.getStylesheets().forEach(function extract_rules(stylesheet){Array.prototype.forEach.call(self.getCSSRules(stylesheet),function filter_by_column_selector(rule){try{if(rule.media&&rule.cssRules&&self.mediaRuleHasColumnsSelector(rule.cssRules)){newMediaRules.push(rule);}}catch(e){}});});var oldRules=mediaRules.filter(function(el){return newMediaRules.indexOf(el)===-1;});mediaQueries.filter(function(el){return oldRules.indexOf(el.rule)!==-1;}).forEach(function(el){el.mql.removeListener(self.mediaQueryChange);});mediaQueries=mediaQueries.filter(function(el){return oldRules.indexOf(el.rule)===-1;});newMediaRules.filter(function(el){return mediaRules.indexOf(el)==-1;}).forEach(function(rule){var mql=global.matchMedia(rule.media.mediaText);mql.addListener(self.mediaQueryChange);mediaQueries.push({rule:rule,mql:mql});});mediaRules.length=0;mediaRules=newMediaRules;};self.rescanMediaQueries=function rescanMediaQueries(){self.scanMediaQueries();Array.prototype.forEach.call(grids,self.recreateColumns);};self.nextElementColumnIndex=function nextElementColumnIndex(grid,fragments){var children=grid.children,m=children.length,lowestRowCount=0,child,currentRowCount,i,index=0;for(i=0;i<m;i++){child=children[i];currentRowCount=child.children.length+(fragments[i].children||fragments[i].childNodes).length;if(lowestRowCount===0){lowestRowCount=currentRowCount;}
if(currentRowCount<lowestRowCount){index=i;lowestRowCount=currentRowCount;}}
return index;};self.createFragmentsList=function createFragmentsList(quantity){var fragments=new Array(quantity),i=0;while(i!==quantity){fragments[i]=document.createDocumentFragment();i++;}
return fragments;};self.appendElements=function appendElements(grid,elements){var columns=grid.children,numberOfColumns=columns.length,fragments=self.createFragmentsList(numberOfColumns);Array.prototype.forEach.call(elements,function append_to_next_fragment(element){var columnIndex=self.nextElementColumnIndex(grid,fragments);fragments[columnIndex].appendChild(element);});Array.prototype.forEach.call(columns,function insert_column(column,index){column.appendChild(fragments[index]);});};self.prependElements=function prependElements(grid,elements){var columns=grid.children,numberOfColumns=columns.length,fragments=self.createFragmentsList(numberOfColumns),columnIndex=numberOfColumns-1;elements.forEach(function append_to_next_fragment(element){var fragment=fragments[columnIndex];fragment.insertBefore(element,fragment.firstChild);if(columnIndex===0){columnIndex=numberOfColumns-1;}else{columnIndex--;}});Array.prototype.forEach.call(columns,function insert_column(column,index){column.insertBefore(fragments[index],column.firstChild);});var fragment=document.createDocumentFragment(),numberOfColumnsToExtract=elements.length%numberOfColumns;while(numberOfColumnsToExtract--!==0){fragment.appendChild(grid.lastChild);}
grid.insertBefore(fragment,grid.firstChild);};self.registerGrid=function registerGrid(grid){if(global.getComputedStyle(grid).display==="none"){return;}
var range=document.createRange();range.selectNodeContents(grid);var items=document.createElement("div");items.appendChild(range.extractContents());add_to_dataset(items,'umicolumns',0);self.addColumns(grid,items);grids.push(grid);};self.init=function init(){var css=document.createElement("style");css.innerHTML="[data-umicolumns]::before{display:block;visibility:hidden;position:absolute;font-size:1px;}";document.head.appendChild(css);var gridElements=document.querySelectorAll("[data-umicolumns]");Array.prototype.forEach.call(gridElements,self.registerGrid);self.scanMediaQueries();};self.init();return{appendElements:self.appendElements,prependElements:self.prependElements,registerGrid:self.registerGrid,recreateColumns:self.recreateColumns,rescanMediaQueries:self.rescanMediaQueries,init:self.init,append_elements:self.appendElements,prepend_elements:self.prependElements,register_grid:self.registerGrid,recreate_columns:self.recreateColumns,rescan_media_queries:self.rescanMediaQueries};})(window,window.document);return salvattore;}));